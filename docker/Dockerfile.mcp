# Multi-MCP proxy server (SSE on port 8081).
# Build from repo root: docker build -f docker/Dockerfile.mcp .
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

WORKDIR /app

# Node.js for MCP servers that use npx (e.g. filesystem); build-essential + portaudio for pyaudio (shared lockfile)
RUN apt-get update && apt-get install -y \
    curl \
    gcc \
    libportaudio2 \
    portaudio19-dev \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install uv (already in base image)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Project: config, src, tools, main_mcp, pyproject
COPY pyproject.toml uv.lock* ./
COPY config/ config/
COPY src/ src/
COPY tools/ tools/
COPY main_mcp.py ./

RUN uv sync --no-dev

ENV PYTHONPATH=/app

EXPOSE 8081

# Default config is config/mcp.json (resolved in-app to /app/config/mcp.json)
CMD ["uv", "run", "python", "main_mcp.py", "--transport", "sse", "--port", "8081", "--host", "0.0.0.0"]
